<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç ”ä¿®åŒ»ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ãƒŠãƒ“ã‚²ãƒ¼ã‚¿ãƒ¼ (GitHub Pageså¯¾å¿œç‰ˆ)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Chosen Palette: Clinical Calm (Slate, Teal, Blue) -->
  <!-- Application Structure Plan:
         Existing structure remains: Mode switch (Admission/Daily), Step-by-step navigation, and Time allocation chart.
         NEW ADDITION: API Key Management UI in the header and localStorage persistence.
         This ensures the API key is never hardcoded, making it safe for public GitHub deployment.
         A settings modal allows users to input and save their own key to their browser's local storage.
    -->
  <!-- Visualization & Content Choices:
         1. Time Allocation Donut Chart (Chart.js): Goals -> Inform residents how to prioritize sections. Interaction -> Updates based on selected mode.
         2. Comparison Cards (HTML/Tailwind): Goal -> Show "Good" vs "Bad" medical phrasing.
         3. AI Workspace: Integrated Gemini API for Critique, Refinement, and Case Generation.
         CONFIRMATION: NO SVG graphics used. NO Mermaid JS used.
    -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap');

    body {
      font-family: 'Noto Sans JP', sans-serif;
      background-color: #f1f5f9;
    }

    .chart-container {
      position: relative;
      width: 100%;
      max-width: 300px;
      height: 220px;
      margin: 0 auto;
    }

    .active-step {
      border-left: 4px solid #0f766e;
      background-color: #f0fdfa;
      color: #0f766e;
      font-weight: bold;
    }

    .step-item {
      transition: all 0.2s ease;
    }

    .step-item:hover:not(.active-step) {
      background-color: #f8fafc;
      padding-left: 0.5rem;
    }

    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }

    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    .ai-loading {
      animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: .5;
      }
    }
  </style>
</head>

<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

  <!-- Header -->
  <header class="bg-white shadow-sm z-10 flex-none">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <span class="text-2xl text-teal-600">âœš</span>
        <h1 class="text-xl font-bold text-slate-800 tracking-tight">ç ”ä¿®åŒ»ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ»ãƒŠãƒ“ <span
            class="text-teal-500 text-xs font-normal">âœ¨AI Ver.</span></h1>
      </div>

      <div class="flex items-center gap-4">
        <div class="flex bg-slate-100 p-1 rounded-lg">
          <button id="btn-admission" onclick="switchMode('admission')"
            class="px-3 py-1.5 rounded-md text-xs font-medium transition-colors bg-white text-teal-700 shadow-sm">æ–°å…¥é™¢</button>
          <button id="btn-daily" onclick="switchMode('daily')"
            class="px-3 py-1.5 rounded-md text-xs font-medium text-slate-500 hover:text-slate-700 transition-colors">å®šæœŸå ±å‘Š</button>
        </div>

        <button onclick="toggleSettings()" class="p-2 text-slate-400 hover:text-teal-600 transition-colors relative">
          <span class="text-xl">âš™ï¸</span>
          <span id="key-badge" class="absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full hidden"></span>
        </button>

        <button onclick="toggleTimer()"
          class="flex items-center gap-2 text-slate-500 hover:text-teal-600 transition-colors">
          <span class="text-xl">â±</span>
          <span class="text-sm font-medium hidden sm:block">ã‚¿ã‚¤ãƒãƒ¼</span>
        </button>
      </div>
    </div>
  </header>

  <main
    class="flex-1 max-w-7xl w-full mx-auto p-4 sm:p-6 lg:p-8 grid grid-cols-1 lg:grid-cols-12 gap-6 overflow-hidden">

    <!-- Sidebar Navigation -->
    <aside class="lg:col-span-3 flex flex-col gap-6 overflow-y-auto no-scrollbar pr-2">
      <div class="bg-white rounded-xl p-5 shadow-sm border border-slate-200">
        <h2 class="text-lg font-bold text-slate-800 mb-1" id="intro-title"></h2>
        <div class="text-xs font-bold text-teal-600 mb-3" id="target-time"></div>
        <p class="text-sm text-slate-600 leading-relaxed" id="intro-text"></p>
      </div>

      <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex-1 flex flex-col min-h-0">
        <nav class="flex-1 overflow-y-auto py-2" id="step-nav"></nav>
      </div>
    </aside>

    <!-- Main Content Area -->
    <section class="lg:col-span-6 flex flex-col overflow-hidden h-full">
      <div id="content-card"
        class="bg-white rounded-xl shadow-lg border border-slate-200 flex-1 flex flex-col overflow-hidden">
        <div class="p-6 border-b border-slate-100 flex-none">
          <div class="flex justify-between items-center mb-1">
            <span
              class="inline-block px-2 py-1 bg-teal-50 text-teal-700 text-xs font-bold rounded uppercase tracking-wider"
              id="step-label"></span>
            <button onclick="toggleAIPanel()"
              class="text-xs font-bold text-teal-600 hover:bg-teal-50 px-2 py-1 rounded transition-colors border border-teal-200">âœ¨
              AIãƒ„ãƒ¼ãƒ«</button>
          </div>
          <h2 class="text-2xl font-bold text-slate-800" id="step-title"></h2>
        </div>

        <div class="flex-1 overflow-y-auto p-6" id="main-scroll-area">
          <div id="step-content">
            <div class="mb-6">
              <h3 class="text-sm font-bold text-slate-900 mb-2 flex items-center gap-2"><span
                  class="text-teal-500">â—</span> ç›®çš„ (Goal)</h3>
              <p class="text-slate-600 leading-relaxed" id="step-goal"></p>
            </div>
            <div class="mb-6 bg-slate-50 rounded-lg p-4 border border-slate-100">
              <h3 class="text-sm font-bold text-slate-900 mb-3">ãƒã‚¤ãƒ³ãƒˆ</h3>
              <ul class="space-y-2 text-sm text-slate-600" id="step-points"></ul>
            </div>
            <div class="grid grid-cols-1 gap-4 mb-6">
              <div class="bg-green-50 rounded-lg p-4 border border-green-100">
                <div class="flex items-center gap-2 mb-2">
                  <span class="bg-green-500 text-white text-xs font-bold px-2 py-0.5 rounded">GOOD</span>
                </div>
                <p class="text-sm text-slate-800 italic" id="step-good"></p>
              </div>
              <div class="bg-red-50 rounded-lg p-4 border border-red-100">
                <div class="flex items-center gap-2 mb-2">
                  <span class="bg-red-400 text-white text-xs font-bold px-2 py-0.5 rounded">BAD</span>
                </div>
                <p class="text-sm text-slate-800 italic" id="step-bad"></p>
                <p class="text-xs text-red-600 mt-1" id="step-bad-reason"></p>
              </div>
            </div>
          </div>

          <!-- Gemini AI Tools Panel -->
          <div id="ai-tools-panel" class="hidden space-y-4 border-t border-slate-100 pt-4 mt-4">
            <div class="bg-teal-50 rounded-xl p-5 border border-teal-100">
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-bold text-teal-800">âœ¨ Gemini AI ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹</h3>
                <button onclick="toggleAIPanel()" class="text-xs text-teal-600">é–‰ã˜ã‚‹</button>
              </div>
              <div id="api-key-warning"
                class="hidden mb-3 p-3 bg-red-100 text-red-700 text-xs rounded-lg border border-red-200">
                âš ï¸ APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å³ä¸Šã® âš™ï¸ ã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰è¨­å®šã—ã¦ãã ã•ã„ã€‚
              </div>
              <textarea id="ai-input"
                class="w-full h-24 p-3 text-sm rounded-lg border border-teal-200 outline-none resize-none mb-3"
                placeholder="ã“ã“ã«è‡ªåˆ†ã®åŸç¨¿ã‚’å…¥åŠ›..."></textarea>
              <div class="flex flex-wrap gap-2">
                <button onclick="aiCritique()"
                  class="flex-1 bg-teal-600 text-white px-3 py-2 rounded-md text-xs font-bold hover:bg-teal-700 transition-colors">âœ¨
                  æ·»å‰Š</button>
                <button onclick="aiRefineOneLiner()"
                  class="flex-1 bg-white text-teal-700 border border-teal-300 px-3 py-2 rounded-md text-xs font-bold">âœ¨
                  è¦ç´„</button>
                <button onclick="aiGenerateCase()"
                  class="flex-1 bg-white text-teal-700 border border-teal-300 px-3 py-2 rounded-md text-xs font-bold">âœ¨
                  ç—‡ä¾‹ç”Ÿæˆ</button>
              </div>
              <div id="ai-output-container"
                class="hidden mt-4 p-4 bg-white rounded-lg border border-teal-200 shadow-inner">
                <div id="ai-loading-indicator" class="hidden ai-loading text-teal-500 text-center py-4"><span
                    class="text-sm font-bold">Gemini å®Ÿè¡Œä¸­...</span></div>
                <div id="ai-response-text" class="text-sm text-slate-700 whitespace-pre-wrap leading-relaxed"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="p-4 border-t border-slate-100 bg-slate-50 flex justify-between items-center">
          <button onclick="prevStep()" id="btn-prev" class="px-4 py-2 text-sm text-slate-500 disabled:opacity-30">â†
            å‰ã¸</button>
          <span class="text-xs text-slate-400 font-medium" id="step-counter"></span>
          <button onclick="nextStep()" id="btn-next"
            class="px-4 py-2 text-sm bg-slate-800 text-white rounded disabled:opacity-30">æ¬¡ã¸ â†’</button>
        </div>
      </div>
    </section>

    <!-- Right Sidebar -->
    <aside class="lg:col-span-3 flex flex-col gap-6">
      <div class="bg-white rounded-xl p-5 shadow-sm border border-slate-200">
        <h3 class="text-sm font-bold text-slate-800 mb-4 border-b pb-2">æ™‚é–“é…åˆ†ç›®å®‰</h3>
        <div class="chart-container"><canvas id="timeChart"></canvas></div>
      </div>
      <div class="bg-gradient-to-br from-teal-50 to-blue-50 rounded-xl p-5 shadow-sm border border-teal-100">
        <h3 class="text-sm font-bold text-teal-800 mb-2">ğŸ’¡ ã‚³ãƒ„</h3>
        <div id="quick-tip-content" class="text-sm text-teal-900 leading-relaxed"></div>
      </div>
    </aside>
  </main>

  <!-- Settings Modal (API Key) -->
  <div id="settings-modal"
    class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
      <h3 class="text-lg font-bold text-slate-800 mb-2">APIè¨­å®š</h3>
      <p class="text-xs text-slate-500 mb-6 leading-relaxed">AIæ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯Google
        Geminiã®APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™ã€‚ã‚­ãƒ¼ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ã®ã¿ä¿å­˜ã•ã‚Œã€GitHubç­‰ã®å¤–éƒ¨ã‚µãƒ¼ãƒãƒ¼ã¸é€ä¿¡ã•ã‚Œã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>

      <div class="mb-6">
        <label class="block text-xs font-bold text-slate-700 uppercase mb-2">Gemini API Key</label>
        <input type="password" id="api-key-input"
          class="w-full p-3 text-sm rounded-lg border border-slate-200 focus:ring-2 focus:ring-teal-500 outline-none"
          placeholder="AIzaSy...">
        <p class="mt-2 text-[10px] text-slate-400">â€»ã‚­ãƒ¼ã‚’ãŠæŒã¡ã§ãªã„æ–¹ã¯ <a href="https://aistudio.google.com/" target="_blank"
            class="text-teal-600 underline">Google AI Studio</a> ã§ç„¡æ–™ã§å–å¾—ã§ãã¾ã™ã€‚</p>
      </div>

      <div class="flex gap-3">
        <button onclick="saveApiKey()"
          class="flex-1 bg-teal-600 text-white py-2.5 rounded-lg text-sm font-bold hover:bg-teal-700">ä¿å­˜ã—ã¦é–‰ã˜ã‚‹</button>
        <button onclick="toggleSettings()"
          class="flex-1 bg-slate-100 text-slate-600 py-2.5 rounded-lg text-sm font-bold">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <!-- Timer Modal -->
  <div id="timer-modal"
    class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full text-center">
      <h3 class="text-lg font-bold text-slate-800 mb-4">ç·´ç¿’ã‚¿ã‚¤ãƒãƒ¼</h3>
      <div class="text-6xl font-mono font-bold text-slate-900 mb-6" id="timer-display">00:00</div>
      <div class="flex justify-center gap-4 mb-6">
        <button onclick="startTimer()"
          class="w-12 h-12 rounded-full bg-teal-500 text-white flex items-center justify-center">â–¶</button>
        <button onclick="pauseTimer()"
          class="w-12 h-12 rounded-full bg-slate-200 text-slate-600 flex items-center justify-center">â¸</button>
        <button onclick="resetTimer()"
          class="w-12 h-12 rounded-full bg-red-100 text-red-500 flex items-center justify-center">âŸ³</button>
      </div>
      <button onclick="toggleTimer()" class="text-sm text-slate-500 underline">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <script>
    const presentationData = {
      admission: {
        title: "æ–°å…¥é™¢ãƒ—ãƒ¬ã‚¼ãƒ³ (5åˆ†)",
        description: "å…¨ä½“åƒã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã®åŸºæœ¬å‹ã€‚SOAPå½¢å¼ã‚’ãƒ™ãƒ¼ã‚¹ã«ã€è¨ºæ–­ã¨æ²»ç™‚æ–¹é‡ã‚’è«–ç†çš„ã«ä¼ãˆã¾ã™ã€‚",
        time: "5åˆ†",
        steps: [
          { title: "ID & CC (è¦ç´„ãƒ»ä¸»è¨´)", label: "å°å…¥", timeAlloc: 30, goal: "èª°ãŒã€ä½•ã®ãŸã‚ã«æ¥ãŸã‹ã‚’ä¸€è¨€ã§ä¼ãˆã‚‹ã€‚", points: ["å¹´é½¢ã€æ€§åˆ¥ã€æœ€é‡è¦æ—¢å¾€ã‚’1ã¤ã€‚", "ä¸»è¨´ã‚’åŒ»å­¦ç”¨èªã«å¤‰æ›ã€‚", "ç·Šæ€¥æ€§ã‚’åŒ‚ã‚ã›ã‚‹ã€‚"], good: "75æ­³ç”·æ€§ã€ç¶­æŒé€æä¸­ã€‚çªç„¶ç™ºç—‡ã®è…¹ç—›ã¨å˜”åã§æ¥é™¢ã€‚", bad: "ç”°ä¸­ã•ã‚“ã§ã™ã€‚ãŠè…¹ãŒç—›ã„ã¨è¨€ã£ã¦æ•‘æ€¥è»Šã§æ¥ã¾ã—ãŸã€‚", badReason: "æƒ…å ±ã¯æ§‹é€ åŒ–ã€‚åå‰ã¯ä¸è¦ã€‚", tip: "æœ€åˆã®ä¸€æ–‡ï¼ˆOne-linerï¼‰ã§å‹è² ãŒæ±ºã¾ã‚Šã¾ã™ã€‚" },
          { title: "HPI (ç¾ç—…æ­´)", label: "S", timeAlloc: 90, goal: "æ™‚ç³»åˆ—ã§ç‰©èªã‚’æ§‹æˆã—ã€é‘‘åˆ¥ã‚’çµã‚Šè¾¼ã‚€ã€‚", points: ["ç™ºç—‡èµ·ç‚¹ã€æ€§è³ªã€å¢—æ‚ªå› å­ã€‚", "é‡è¦ãªé™°æ€§æ‰€è¦‹ã‚’å«ã‚ã‚‹ã€‚"], good: "æ˜¨æ™©å¤•é£Ÿå¾Œã«å¿ƒçª©éƒ¨ç—›ã€‚æŒç¶šæ€§ã§èƒŒéƒ¨æ”¾æ•£ã‚ã‚Šã€‚å˜”åãƒ»ä¸‹ç—¢ãªã—ã€‚", bad: "ãšã£ã¨ç—›ã„ãã†ã§ã™ã€‚ã‚ã€èƒŒä¸­ã‚‚ç—›ã„ã¨è¨€ã£ã¦ã¾ã—ãŸã€‚", badReason: "ã€Œãã†ã„ãˆã°ã€ã®å¾Œå‡ºã—ã¯å³ç¦ã€‚", tip: "é™°æ€§æ‰€è¦‹ã¯çŸ¥çš„ãªã‚¢ãƒ”ãƒ¼ãƒ«ã«ãªã‚Šã¾ã™ã€‚" },
          { title: "Background (æ—¢å¾€ãƒ»èƒŒæ™¯)", label: "èƒŒæ™¯", timeAlloc: 60, goal: "ãƒªã‚¹ã‚¯å› å­ã‚„ç¤¾ä¼šçš„èƒŒæ™¯ã‚’æç¤ºã€‚", points: ["é–¢é€£ã™ã‚‹æ—¢å¾€ã‚’å„ªå…ˆã€‚", "å†…æœè–¬ã‚’å¼·èª¿ã€‚", "ADLã€ã‚­ãƒ¼ãƒ‘ãƒ¼ã‚½ãƒ³ã€‚"], good: "AFã‚ã‚ŠDOACå†…æœä¸­ã€‚å–«ç…™40å¹´ã€‚ADLè‡ªç«‹ã€ç‹¬å±…ã€‚", bad: "è–¬ã¯ã„ã£ã±ã„é£²ã‚“ã§ã¾ã™ã€‚ãŠé…’ã¯ãŸã¾ã«ã€‚", badReason: "ã€Œã„ã£ã±ã„ã€ã€ŒãŸã¾ã«ã€ã¯å®šé‡åŒ–ã€‚", tip: "NKDAï¼ˆè–¬ç‰©ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ãªã—ï¼‰ã®æ˜è¨€ã‚’ã€‚" },
          { title: "Objective (èº«ä½“ãƒ»æ¤œæŸ»)", label: "O", timeAlloc: 105, goal: "å®¢è¦³çš„ãƒ‡ãƒ¼ã‚¿ã§ç·Šæ€¥åº¦ã‚’è£ä»˜ã‘ã‚‹ã€‚", points: ["ç•°å¸¸å€¤ã®å¼·èª¿ã€‚", "General Appearanceã€‚", "ç”»åƒã®è¨€èªåŒ–ã€‚"], good: "BP 150/90, HR 110. è‹¦æ‚¶æ§˜ã€‚è…¹éƒ¨åœ§ç—›ã‚ã‚‹ãŒåè·³ç—›ãªã—ã€‚CTã§è†µè…«å¤§ã‚ã‚Šã€‚", bad: "ãƒã‚¤ã‚¿ãƒ«ã¯æ™®é€šã€‚æ¤œæŸ»ã¯ç‚ç—‡é«˜ã‚ã€‚", badReason: "å…·ä½“çš„æ•°å€¤ã‚’ç”¨ã„ã€ç”»åƒã¯è§£é‡ˆã‚’åŠ ãˆã‚‹ã€‚", tip: "Head-to-Toeã®é †ã§æŠœã‘æ¼ã‚Œé˜²æ­¢ã€‚" },
          { title: "Assessment (ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆ)", label: "A", timeAlloc: 90, goal: "æƒ…å ±ã‚’çµ±åˆã—ã€è«–ç†çš„ã«æ¨è«–ã™ã‚‹ã€‚æœ€é‡è¦ã€‚", points: ["Summary Statementã‹ã‚‰é–‹å§‹ã€‚", "Problem Listã®æç¤ºã€‚", "é™¤å¤–ç–¾æ‚£ã®ç†ç”±ã€‚"], good: "AFã®ã‚ã‚‹75æ­³ç”·æ€§ã€ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«å¾Œã®è…¹ç—›ã€‚æ‰€è¦‹ã‚ˆã‚Š#1 æ€¥æ€§è†µç‚ã¨è¨ºæ–­ã€‚", bad: "è†µç‚ã ã¨æ€ã„ã¾ã™ã€‚å…¥é™¢ã§ã„ã„ã§ã™ã‹ï¼Ÿ", badReason: "çµè«–ã ã‘ã§ãªããƒ—ãƒ­ã‚»ã‚¹ã‚’èªã‚‹ã€‚", tip: "æ„Ÿæƒ³ã§ã¯ãªãã€äº‹å®Ÿã«åŸºã¥ã„ãŸæ¨è«–ã§ã™ã€‚" },
          { title: "Plan (æ–¹é‡)", label: "P", timeAlloc: 45, goal: "å…·ä½“çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æç¤ºã€‚", points: ["å…¥é™¢æŒ‡ç¤ºã€è¿½åŠ æ¤œæŸ»ã€‚", "å®¶æ—ã¸ã®èª¬æ˜(IC)ã€‚"], good: "å¤§é‡è¼¸æ¶²ã‚’é–‹å§‹ã—ç–¼ç—›ç®¡ç†ã€‚ã‚¨ã‚³ãƒ¼è¿½åŠ ã€‚é‡ç—‡åŒ–ãƒªã‚¹ã‚¯ã‚’èª¬æ˜ã€‚", bad: "ç‚¹æ»´ã—ã¦æ§˜å­ã‚’è¦‹ã¾ã™ã€‚", badReason: "ã€Œæ§˜å­ã‚’è¦‹ã‚‹ã€ã¯Planã§ã¯ãªã„ã€‚", tip: "é€€é™¢ã®ã‚´ãƒ¼ãƒ«ã‚’æç¤ºã—ã¾ã—ã‚‡ã†ã€‚" }
        ]
      },
      daily: {
        title: "å®šæœŸå ±å‘Š (1åˆ†)",
        description: "å›è¨ºç”¨ã€‚å¤‰åŒ–ç‚¹ã«çµã‚Šã€ä»Šæ—¥ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ‰¿èªã—ã¦ã‚‚ã‚‰ã„ã¾ã™ã€‚",
        time: "1åˆ†",
        steps: [
          { title: "Summary (è¦ç´„)", label: "å°å…¥", timeAlloc: 10, goal: "ã©ã®æ‚£è€…ã®ä½•æ—¥ç›®ã‹ã‚’åŒæœŸã€‚", points: ["åå‰ã€ç–¾æ‚£ã€çµŒéæ—¥æ•°ã€‚"], good: "è‚ºç‚ã§å…¥é™¢5æ—¥ç›®ã®80æ­³å¥³æ€§ã€ä½è—¤ã•ã‚“ã§ã™ã€‚", bad: "ä½è—¤ã•ã‚“ã§ã™ãŒã€ç†±ä¸‹ãŒã‚Šã¾ã—ãŸã€‚", tip: "ã€ŒæŠ—èŒè–¬â—‹æ—¥ç›®ã€ã¯å¿…é ˆã€‚" },
          { title: "Update (ä¸»è¦³ãƒ»å®¢è¦³)", label: "S/O", timeAlloc: 30, goal: "å›å¾©ãƒ»æ‚ªåŒ–ã®ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’æç¤ºã€‚", points: ["å¤œé–“ã‚¤ãƒ™ãƒ³ãƒˆã€‚", "é£Ÿäº‹æ‘‚å–ã€‚", "ãƒã‚¤ã‚¿ãƒ«ã®å¤‰åŒ–ã€‚"], good: "å¤œé–“ä¸ç©ãªã—ã€‚æœé£Ÿå…¨é‡ã€‚è§£ç†±ã—SpO2ã‚‚æ”¹å–„ã—ã¾ã—ãŸã€‚", bad: "ã‚ˆãå¯ã¦ã¾ã—ãŸã€‚è¡€åœ§ã¯120...", tip: "æ­£å¸¸å€¤ã®ç¾…åˆ—ã¯ä¸è¦ã€‚" },
          { title: "Plan (çµè«–)", label: "A/P", timeAlloc: 20, goal: "å¤‰æ›´ç‚¹ã‚’æ‰¿èªã—ã¦ã‚‚ã‚‰ã†ã€‚", points: ["ä»Šæ—¥ã®To Doã‚’ææ¡ˆã€‚"], good: "é †èª¿ã§ã™ã€‚æœ¬æ—¥ã‚ˆã‚ŠæŠ—èŒè–¬ã‚’å†…æœã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚", bad: "è‰¯ããªã£ã¦ã„ã‚‹ã®ã§åŒã˜ã§ã™ã€‚", tip: "ã€Œã€œã—ã‚ˆã†ã¨æ€ã„ã¾ã™ã€ã¨ææ¡ˆã™ã‚‹ã€‚" }
        ]
      }
    };

    let currentMode = 'admission';
    let currentStepIndex = 0;
    let timerInterval, timerSeconds = 0;
    let chartInstance = null;
    let savedApiKey = "";

    const els = {
      introTitle: document.getElementById('intro-title'),
      introText: document.getElementById('intro-text'),
      targetTime: document.getElementById('target-time'),
      stepNav: document.getElementById('step-nav'),
      stepLabel: document.getElementById('step-label'),
      stepTitle: document.getElementById('step-title'),
      stepGoal: document.getElementById('step-goal'),
      stepPoints: document.getElementById('step-points'),
      stepGood: document.getElementById('step-good'),
      stepBad: document.getElementById('step-bad'),
      stepBadReason: document.getElementById('step-bad-reason'),
      stepCounter: document.getElementById('step-counter'),
      btnPrev: document.getElementById('btn-prev'),
      btnNext: document.getElementById('btn-next'),
      btnAdmission: document.getElementById('btn-admission'),
      btnDaily: document.getElementById('btn-daily'),
      quickTip: document.getElementById('quick-tip-content'),
      timerModal: document.getElementById('timer-modal'),
      timerDisplay: document.getElementById('timer-display'),
      settingsModal: document.getElementById('settings-modal'),
      apiKeyInput: document.getElementById('api-key-input'),
      keyBadge: document.getElementById('key-badge'),
      aiPanel: document.getElementById('ai-tools-panel'),
      aiInput: document.getElementById('ai-input'),
      aiOutput: document.getElementById('ai-output-container'),
      aiResponse: document.getElementById('ai-response-text'),
      aiLoading: document.getElementById('ai-loading-indicator'),
      apiWarning: document.getElementById('api-key-warning')
    };

    function init() {
      renderChart();
      loadKey();
      loadMode('admission');
    }

    function loadKey() {
      const stored = localStorage.getItem('gemini_api_key');
      if (stored) {
        savedApiKey = stored;
        els.apiKeyInput.value = stored;
        els.keyBadge.classList.add('hidden');
      } else {
        els.keyBadge.classList.remove('hidden');
      }
    }

    function saveApiKey() {
      const key = els.apiKeyInput.value.trim();
      if (key) {
        localStorage.setItem('gemini_api_key', key);
        savedApiKey = key;
        els.keyBadge.classList.add('hidden');
      } else {
        localStorage.removeItem('gemini_api_key');
        savedApiKey = "";
        els.keyBadge.classList.remove('hidden');
      }
      toggleSettings();
      checkApiWarning();
    }

    function checkApiWarning() {
      if (!savedApiKey && !els.aiPanel.classList.contains('hidden')) {
        els.apiWarning.classList.remove('hidden');
      } else {
        els.apiWarning.classList.add('hidden');
      }
    }

    function toggleSettings() { els.settingsModal.classList.toggle('hidden'); }
    function toggleAIPanel() { els.aiPanel.classList.toggle('hidden'); checkApiWarning(); }

    function switchMode(mode) {
      currentMode = mode; currentStepIndex = 0;
      els.btnAdmission.classList.toggle('bg-white', mode === 'admission');
      els.btnAdmission.classList.toggle('text-teal-700', mode === 'admission');
      els.btnDaily.classList.toggle('bg-white', mode === 'daily');
      els.btnDaily.classList.toggle('text-teal-700', mode === 'daily');
      loadMode(mode);
    }

    function loadMode(mode) {
      const data = presentationData[mode];
      els.introTitle.textContent = data.title;
      els.introText.textContent = data.description;
      els.targetTime.textContent = `ç›®æ¨™æ™‚é–“: ${data.time}`;
      renderNav(data.steps);
      updateChart(data.steps);
      loadStep(0);
    }

    function renderNav(steps) {
      els.stepNav.innerHTML = '';
      steps.forEach((step, index) => {
        const btn = document.createElement('button');
        btn.className = `step-item w-full text-left px-4 py-3 border-l-4 border-transparent flex items-center justify-between group ${index === currentStepIndex ? 'active-step' : 'text-slate-500 hover:text-slate-700'}`;
        btn.onclick = () => loadStep(index);
        btn.innerHTML = `<div><span class="text-[10px] font-bold uppercase block opacity-70">${step.label}</span><span class="text-xs font-medium block truncate">${step.title}</span></div><span class="text-[10px] text-slate-300">${step.timeAlloc}s</span>`;
        els.stepNav.appendChild(btn);
      });
    }

    function loadStep(index) {
      const data = presentationData[currentMode].steps[index];
      currentStepIndex = index;
      Array.from(els.stepNav.children).forEach((el, i) => {
        el.className = `step-item w-full text-left px-4 py-3 border-l-4 flex items-center justify-between group ${i === index ? 'active-step' : 'border-transparent text-slate-500 hover:text-slate-700'}`;
      });
      els.stepLabel.textContent = data.label;
      els.stepTitle.textContent = data.title;
      els.stepGoal.textContent = data.goal;
      els.stepPoints.innerHTML = data.points.map(p => `<li class="flex items-start gap-2"><span class="text-teal-500 mt-1">âœ“</span><span>${p}</span></li>`).join('');
      els.stepGood.textContent = `"${data.good}"`;
      els.stepBad.textContent = `"${data.bad}"`;
      els.stepBadReason.textContent = `â€» ${data.badReason || ""}`;
      els.quickTip.textContent = data.tip;
      els.stepCounter.textContent = `${index + 1} / ${presentationData[currentMode].steps.length}`;
      els.btnPrev.disabled = index === 0;
      els.btnNext.disabled = index === presentationData[currentMode].steps.length - 1;
    }

    function nextStep() { if (currentStepIndex < presentationData[currentMode].steps.length - 1) loadStep(currentStepIndex + 1); }
    function prevStep() { if (currentStepIndex > 0) loadStep(currentStepIndex - 1); }

    async function callGemini(prompt, systemPrompt) {
      if (!savedApiKey) { toggleSettings(); return; }
      els.aiOutput.classList.remove('hidden');
      els.aiLoading.classList.remove('hidden');
      els.aiResponse.textContent = "";

      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${savedApiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] }
          })
        });
        if (!response.ok) throw new Error();
        const result = await response.json();
        els.aiResponse.textContent = result.candidates?.[0]?.content?.parts?.[0]?.text || "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
      } catch (e) {
        els.aiResponse.textContent = "APIã‚¨ãƒ©ãƒ¼ã€‚ã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
      } finally {
        els.aiLoading.classList.add('hidden');
      }
    }

    function aiCritique() {
      const step = presentationData[currentMode].steps[currentStepIndex];
      const draft = els.aiInput.value;
      if (!draft) return;
      callGemini(`åŸç¨¿: "${draft}"`, `ã‚ãªãŸã¯æ—¥æœ¬ã®ãƒ™ãƒ†ãƒ©ãƒ³æŒ‡å°åŒ»ã§ã™ã€‚${step.title}ã®ãƒ—ãƒ¬ã‚¼ãƒ³æ·»å‰Šã‚’è¡Œã„ã€1.è‰¯ã„ç‚¹ã€2.æ”¹å–„ç‚¹ã€3.ä¿®æ­£ä¾‹ã‚’æ—¥æœ¬èªã§å»ºè¨­çš„ã«å›ç­”ã—ã¦ãã ã•ã„ã€‚`);
    }

    function aiRefineOneLiner() {
      const draft = els.aiInput.value;
      if (!draft) return;
      callGemini(`ãƒ¡ãƒ¢: "${draft}"`, "åŒ»å­¦çš„ãªè¦ç´„ï¼ˆOne-linerï¼‰ã«å¤‰æ›ã—ã€2-3ã¤ã®æ´—ç·´ã•ã‚ŒãŸæ¡ˆã‚’æ—¥æœ¬èªã§æç¤ºã—ã¦ãã ã•ã„ã€‚");
    }

    function aiGenerateCase() {
      const disease = els.aiInput.value || "æ€¥æ€§å¿ƒç­‹æ¢—å¡";
      callGemini(`ç–¾æ‚£: ${disease}`, "ç·´ç¿’ç”¨ã®è©³ç´°ãªä»®æƒ³ç—‡ä¾‹(ID, HPI, PE, Lab)ã‚’ã€æ—¥æœ¬ã®ç—…é™¢ã®ã‚«ãƒ«ãƒ†ã‚’æ¨¡ã—ãŸå½¢å¼ã§ä½œæˆã—ã¦ãã ã•ã„ã€‚");
    }

    function renderChart() {
      const ctx = document.getElementById('timeChart').getContext('2d');
      chartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: { labels: [], datasets: [{ data: [], backgroundColor: [], borderWidth: 0 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, cutout: '70%' }
      });
    }

    function updateChart(steps) {
      chartInstance.data.labels = steps.map(s => s.label);
      chartInstance.data.datasets[0].data = steps.map(s => s.timeAlloc);
      const colors = ['#e0f2fe', '#bae6fd', '#7dd3fc', '#38bdf8', '#0ea5e9', '#0284c7'];
      chartInstance.data.datasets[0].backgroundColor = steps.map((_, i) => colors[i % colors.length]);
      chartInstance.update();
    }

    function toggleTimer() { els.timerModal.classList.toggle('hidden'); if (els.timerModal.classList.contains('hidden')) pauseTimer(); }
    function startTimer() { if (!timerInterval) timerInterval = setInterval(() => { timerSeconds++; updateTimerDisplay(); }, 1000); }
    function pauseTimer() { clearInterval(timerInterval); timerInterval = null; }
    function resetTimer() { pauseTimer(); timerSeconds = 0; updateTimerDisplay(); }
    function updateTimerDisplay() {
      const m = Math.floor(timerSeconds / 60).toString().padStart(2, '0');
      const s = (timerSeconds % 60).toString().padStart(2, '0');
      els.timerDisplay.textContent = `${m}:${s}`;
    }

    window.onload = init;
  </script>
</body>

</html>
